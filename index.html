<script>
  /* ==== FUNCIONES AUXILIARES ==== */
  function lerp(a, b, t) { return a + (b - a) * t; }
  function mixRGB(c1, c2, t) {
    return [
      Math.round(lerp(c1[0], c2[0], t)),
      Math.round(lerp(c1[1], c2[1], t)),
      Math.round(lerp(c1[2], c2[2], t)),
    ];
  }
  function rgbStr([r,g,b]) { return `rgb(${r}, ${g}, ${b})`; }

  const GREEN  = [0, 255, 0];
  const YELLOW = [255, 255, 0];
  const RED    = [255, 0, 0];

  // ðŸŽ¨ Colores del fondo que queremos interpolar
  const LOW_BLUE  = [0x4D, 0x7C, 0x8A];  // #4D7C8A
  const HIGH_BLUE = [0x1B, 0x40, 0x79];  // #1B4079

  let blinkInterval = null;
  function startBlink() {
    if (blinkInterval) return;
    let toggle = false;
    blinkInterval = setInterval(() => {
      document.body.style.background = toggle 
        ? 'black' 
        : 'linear-gradient(to bottom right, red, darkred)';
      toggle = !toggle;
    }, 300);
  }
  function stopBlink() {
    if (blinkInterval) {
      clearInterval(blinkInterval);
      blinkInterval = null;
    }
  }

  /* ==== SEMÃFORO ==== */
  (async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const audioContext = new AudioCtx();
      const source = audioContext.createMediaStreamSource(stream);
      const analyser = audioContext.createAnalyser();
      analyser.fftSize = 256;
      source.connect(analyser);

      const dataArray = new Uint8Array(analyser.frequencyBinCount);
      const barEl = document.getElementById('bar');
      const estadoImg = document.getElementById('estadoImg');

      function frame() {
        analyser.getByteFrequencyData(dataArray);
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
        const avg = sum / dataArray.length;

        const sensitivity = 2.2;
        const volume = Math.min(100, (avg / 255) * 100 * sensitivity);
        barEl.style.height = volume + '%';

        let color;
        if (volume <= 50) {
          color = mixRGB(GREEN, YELLOW, volume / 50);
        } else {
          color = mixRGB(YELLOW, RED, (volume - 50) / 50);
        }
        const colorStr = rgbStr(color);
        barEl.style.background = colorStr;

        // ðŸŽ¨ Actualiza el fondo segÃºn el volumen (de azul claro a azul oscuro)
        const bgColor = mixRGB(LOW_BLUE, HIGH_BLUE, volume / 100);
        const bgColorStr = rgbStr(bgColor);
        if (!blinkInterval) {
          document.body.style.background =
            `linear-gradient(to bottom right, ${bgColorStr}, #00000030)`;
        }

        // Cambia las imÃ¡genes del semÃ¡foro
        if (volume <= 40) {
          if (!estadoImg.src.includes('verde.png')) estadoImg.src = 'Imagenes/verde.png';
          stopBlink();
        } else if (volume <= 70) {
          if (!estadoImg.src.includes('amarillo.png')) estadoImg.src = 'Imagenes/amarillo.png';
          stopBlink();
        } else {
          if (!estadoImg.src.includes('rojo.png')) estadoImg.src = 'Imagenes/rojo.png';
          startBlink();
        }

        requestAnimationFrame(frame);
      }

      frame();
    } catch (err) {
      alert('Error accediendo al micrÃ³fono: ' + err.name + ' - ' + err.message +
            '\n\nðŸ”§ Revisa:\n1. Que uses HTTPS\n2. Que el micrÃ³fono estÃ© permitido (candado en la URL)\n3. Que no estÃ© ocupado por otro programa.');
      console.error(err);
    }
  })();

  /* ==== CARRUSEL DE IMÃGENES ==== */
  const imagenesCarpeta = [
    "CanvaImgs/img1.png",
    "CanvaImgs/img2.png",
    "CanvaImgs/img3.png"
  ];

  let idx = 0;
  const carruselImg = document.getElementById("carruselImg");

  setInterval(() => {
    idx = (idx + 1) % imagenesCarpeta.length;
    carruselImg.src = imagenesCarpeta[idx];
  }, 30000);
</script>
